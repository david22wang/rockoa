<?php
class weixinqyModel extends Model { protected $URL_public = 'ru0up0kp0wk0rr0up0uu0ow0uw0fco0uu0wk0uk0fpp0ffo0fcr0uh0fpp0kf0of0ur0of0uc0oh0kr0kk0zz0ffp0uz0ffc0fcc0fck0ru0kk0fcw0ffp0rk0fco0oh0fpc0rr0kh0oh0fcz0rk0oc0wk0ffk0kr0oc0fcc0ffp0uz0ku0uw0ffp0rk0fco0oz0ok07'; protected $URL_gettoken = 'lz0nz0yq0by0uzz0gu0ng0uub0lz0yg0nk0ny013'; protected $URL_jsapiticket = 'np0up0bk0zb0bb0up0hhw0hww0bn0bb0kk0hhw0bb0uh0bw0hhw0bn0up0hhk0hpb0hpp0ku0ub0ub09'; protected $URL_messagesend = 'gq0qn0qb0ozz0gg0rw0nw0oow0gw0qu0rn0ozz0gw0qn0ru0own011'; protected $URL_mediaupload = 'ml0ly0lg0kuy0my0ly0gm0kkl0kuu0ll0gg0kkq0ml0qu0yu0kuy014'; protected $URL_mediaget = 'ku0uz0uo0caz0kz0uz0ok0ccu0ka0wa0uo0hu06'; protected $URL_getuserinfo = 'pff0rr0kr0pfr0bb0pfz0zk0ppf0bf0rr0rh0ob0bb0zf0ru0php0bk0rk0zw0pfb0br0ppb0zr0zr08'; protected $URL_userlist = 'zoo0gg0qg0zog0yy0zob0bq0zzb0yq0gg0qg0rg012'; protected $URL_userget = 'iee0hh0ph0ieh0ww0iec0cp0iie0we0hh0hi0ch02'; protected $URL_usercreate = 'pff0rr0kr0pfr0bb0pfz0zk0pfu0bb0pfb0ru0pfo0pff0kp0rz0zr08'; protected $URL_userupdate = 'ess0pp0fp0esp0hh0esa0af0dh0hh0fe0pi0esd0ess0fe0pa0ap01'; protected $URL_userdelete = 'zoo0gg0qg0zog0yy0zob0bq0zoq0yo0gq0zuo0zog0zoo0qz0gb0bg012'; protected $URL_batchdelete = 'oww0qq0nq0owq0gg0owr0rn0owr0qg0qq0qz0owb0gn0no0qz0owq0gq0no0qb0kq0gw0qo0rq0rq011'; protected $URL_deptlist = 'ka0zc0uo0cck0uk0uu0zh0hu0ku0uz0uo0ccz0caa0oz0wz0ccw0kz0uu0zu0hu06'; protected $URL_deptcreate = 'we0pi0hf0iiw0hw0hh0pa0ah0wh0hp0hf0iip0iee0fp0cp0ief0ww0iew0hf0iea0iee0pi0hc0ch02'; protected $URL_deptupdate = 'gw0no0qb0oog0qg0qq0nk0kq0gq0qn0qb0oon0oww0bn0rn0kg0gg0no0qz0owk0oww0no0qr0rq011'; protected $URL_deptdelete = 'lz0gu0yq0uul0yl0yy0gb0by0ly0yg0yq0uug0uzz0qg0ng0uzg0lz0yg0ukz0uzy0uzz0gu0yn0ny013'; protected $URL_agentget = 'bn0br0hpp0hpb0nb0hhp0bh0hhb0np0up0bk0zb09'; protected $URL_agentset = 'qg0qn0oww0owq0gq0oow0qo0ooq0gg0rw0qb0kq011'; protected $URL_chatcreate = 'appchat/create'; protected $URL_chatsend = 'appchat/send'; protected $URL_checkindata = 'ph0as0esd0esp0ph0as0eec0eei0hp0esa0af0ees0hs0pp0pi0esc0hf0fe0pc0esc0hf0as0esp0eef0hs0fe0fs0dp0ph0pe0ap0ap01'; protected $URL_checkinoption= 'oz0pj0djf0djo0oz0pj0ddh0dda0zo0djp0pw0ddj0zj0oo0oa0djh0zw0wd0oh0djh0zw0pj0djo0ddw0zo0pd0hh0fo0zw0ow0pw0ddw04'; protected $URL_menuget = 'zo0ow0oh0ddw0djj0oc0pw0ddj0zj0oo0od0po04'; protected $URL_menudelete = 'wh0hp0hf0iip0iee0hd0cp0iep0we0hp0ije0ieh0iee0pi0hc0ch02'; protected $URL_menucreate = 'hp0pf0pc0eef0ess0pj0af0esc0hh0esh0pc0esd0ess0fe0pa0ap01'; public $corpid = ''; public $secret = ''; public $backarr = array(); public $deptrootid = 1; public function initWeixin(){} public function initModel() { $this->backarr = array('errcode'=>-1, 'msg'=>'sorry,error'); $this->option = m('option'); $djid = (int)$this->option->getval('weixinqy_deptid','0'); if($djid>0)$this->deptrootid = $djid; $this->initWeixin(); } public function gettourl($can) { $url = $this->URL_public; if(substr($url,0,4)!='http'){ $url=$this->rock->jm->uncrypt($url); $url.=$this->rock->jm->uncrypt($this->$can); }else{ $url.=$this->$can; } if(substr($url,0,4)!='http'){ echo json_encode($this->backerror('访问有误，请重新安装模块')); exit; } return $url; } public function readwxset() { if($this->corpid!='')return; $this->corpid = $this->option->getval('weixinqy_corpid'); $this->secret = $this->option->getval('weixinqy_secret'); if($this->corpid=='')showreturn('','没有设置企业微信',201); return $this->corpid; } public function gethuidiao() { $huitoken = $this->option->getval('weixinqy_huitoken'); $aeskey = $this->option->getval('weixinqy_aeskey'); $corpid = $this->corpid; if($corpid=='')$corpid = $this->option->getval('weixinqy_corpid'); return array( 'huitoken' => $huitoken, 'aeskey' => $aeskey, 'corpid' => $corpid, ); } public function gettoken($lx=0, $isyy=false) { $time = date('Y-m-d H:i:s', time()-2*3600); $num = 'weixinqy_token'.$lx.''; if($isyy)$num.='_agent'; $rs = $this->option->getone("`num`='$num' and `optdt`>'$time'"); $val = ''; if($rs)$val = $rs['value']; if(isempt($val)){ $this->readwxset(); $secret = $this->secret; if($lx>0 || $isyy){ $secret = m('wxqy_agent')->getmou('secret', "`agentid`='$lx'"); } if($isyy && isempt($secret))showreturn('','请先设置应用的secret', 201); if(isempt($secret))return ''; $url = ''.$this->gettourl('URL_gettoken').'?corpid='.$this->corpid.'&corpsecret='.$secret.''; $result = c('curl')->getcurl($url); if($result != ''){ $arr = json_decode($result); if(!isset($arr->access_token)){ showreturn('',$result,201); }else{ $val = $arr->access_token; $this->option->setval($num, $val); } } } return $val; } public function getticket($lx) { $time = date('Y-m-d H:i:s', time()-2*3600); $num = 'weixinqy_jssdk_token'.$lx.''; $rs = $this->option->getone("`num`='$num' and `optdt`>'$time'"); $val = ''; if($rs)$val = $rs['value']; if(isempt($val)){ $token = $this->gettoken($lx); $url = ''.$this->gettourl('URL_jsapiticket').'?access_token='.$token.''; $result = c('curl')->getcurl($url); if($result != ''){ $arr = json_decode($result); if(!isset($arr->ticket)){ showreturn('', $result, 201); }else{ $val = $arr->ticket; $this->option->setval($num, $val); } } } return $val; } public function setbackarr($code, $msg) { $msg = $this->geterrstr($code, $msg); $this->backarr = array('errcode'=>$code, 'msg'=>$msg); return $this->backarr; } public function backerror($msg, $code=-1) { return $this->setbackarr($code, $msg); } public function clearalltoken() { $this->option->update("value=null", "`num` like 'weixinqy\_%'"); } public function tokenerr() { $this->backarr['msg'] = '无法获取token'; return $this->backarr; } private $errorarray = false; public function geterrstr($code, $str1='') { $str = '{"40001":"不合法的secret参数","40003":"无效的UserID","40004":"不合法的媒体文件类型","40005":"不合法的type参数","40006":"不合法的文件大小","40007":"不合法的media_id参数","40008":"不合法的msgtype参数","40013":"不合法的CorpID","40014":"不合法的access_token","40016":"不合法的按钮个数","40017":"不合法的按钮类型","40018":"不合法的按钮名字长度","40019":"不合法的按钮KEY长度","40020":"不合法的按钮URL长度","40022":"不合法的子菜单级数","40023":"不合法的子菜单按钮个数","40024":"不合法的子菜单按钮类型","40025":"不合法的子菜单按钮名字长度","40026":"不合法的子菜单按钮KEY长度","40027":"不合法的子菜单按钮URL长度","40029":"不合法的oauth_code","40031":"不合法的UserID列表","40032":"不合法的UserID列表长度","40033":"不合法的请求字符","40054":"不合法的子菜单url域名","40055":"不合法的菜单url域名","40056":"不合法的agentid","40057":"不合法的callbackurl或者callbackurl验证失败","40058":"不合法的参数","40059":"不合法的上报地理位置标志位","40063":"参数为空","40066":"不合法的部门列表","40068":"不合法的标签ID","40071":"不合法的标签名字","40072":"不合法的标签名字长度","40073":"不合法的openid","40074":"news消息不支持保密消息类型","40077":"不合法的pre_auth_code参数","40078":"不合法的auth_code参数","40080":"不合法的suite_secret","40082":"不合法的suite_token","40083":"不合法的suite_id","40084":"不合法的permanent_code参数","40085":"不合法的的suite_ticket参数","40086":"不合法的第三方应用appid","40092":"导入文件存在不合法的内容","40093":"不合法的jsapi_ticket参数","40094":"不合法的URL","41001":"缺少access_token参数","41002":"缺少corpid参数","41004":"缺少secret参数","41008":"缺少auth code参数","41009":"缺少userid参数","41010":"缺少url参数","41011":"缺少agentid参数","41016":"缺少title参数","41017":"缺少tagid参数","41021":"缺少suite_id参数","41025":"缺少permanent_code参数","42001":"access_token已过期","42007":"pre_auth_code已过期","42009":"suite_access_token已过期","43004":"指定的userid未绑定微信或未关注微信插件","44004":"文本消息content参数为空","45001":"多媒体文件大小超过限制","45002":"消息内容大小超过限制","45004":"应用description参数长度不符合系统限制","45007":"语音播放时间超过限制","45008":"图文消息的文章数量不符合系统限制","45009":"接口调用超过限制","45022":"应用name参数长度不符合系统限制","45024":"帐号数量超过上限","45026":"触发删除用户数的保护","45032":"图文消息author参数长度超过限制","46003":"菜单未设置","48002":"API接口无权限调用","48003":"不合法的suite_id","48004":"授权关系无效","48005":"API接口已废弃","50001":"redirect_url未登记可信域名","50002":"成员不在权限范围","50003":"应用已禁用","60001":"部门长度不符合限制","60003":"部门ID不存在","60004":"父部门不存在","60005":"部门下存在成员","60006":"部门下存在子部门","60007":"不允许删除根部门","60008":"部门已存在","60009":"部门名称含有非法字符","60010":"部门存在循环关系","60011":"指定的成员\/部门\/标签参数无权限","60012":"不允许删除默认应用","60020":"访问ip不在白名单之中","60102":"UserID已存在","60103":"手机号码不合法","60104":"手机号码已存在","60105":"邮箱不合法","60106":"邮箱已存在","60110":"用户所属部门数量超过限制","60111":"UserID不存在","60112":"成员name参数不合法","60123":"无效的部门id","60124":"无效的父部门id","60125":"非法部门名字","60127":"缺少department参数","60129":"成员手机和邮箱都为空","72023":"发票已被其他公众号锁定","72024":"发票状态错误","72037":"存在发票不属于该用户","80001":"可信域名不正确，或者无ICP备案","81001":"部门下的结点数超过限制（3W）","81002":"部门最多15层","81011":"无权限操作标签","82002":"不合法的PartyID列表长度","82003":"不合法的TagID列表长度","84019":"缺少templateid参数","84020":"templateid不存在","84021":"缺少register_code参数","84022":"无效的register_code参数","84023":"不允许调用设置通讯录同步完成接口","84024":"无注册信息","85002":"包含不合法的词语","85004":"每企业每个月设置的可信域名不可超过20个","85005":"可信域名未通过所有权校验","301024":"获取打卡数据时间间隔不能大于93天"}'; if(!$this->errorarray)$this->errorarray = json_decode($str, true); $bstr = arrvalue($this->errorarray, $code); if(!isempt($bstr)){ $str1 = '('.$bstr.')'.$str1.','.c('xinhu')->helpstr('wxqymsg').''; } return $str1; } }